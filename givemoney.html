<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能紙幣分發機 Pro (平衡版)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    colors: {
                        hk10: '#8b5cf6', // $10 紫色
                        hk20: '#3b82f6', // $20 藍色
                        hk50: '#10b981', // $50 綠色
                        hk100: '#ef4444', // $100 紅色
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%);
            min-height: 100vh;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        
        /* Animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: slideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .result-enter { opacity: 0; animation: fadeUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Custom Scrollbar for list */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #e2e8f0; border-radius: 20px; }
    </style>
</head>
<body class="text-slate-800 pb-24">

    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                    <i class="fa-solid fa-money-bills"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black text-slate-800 tracking-tight">鈔票分發機</h1>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-bold bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded">智能平衡</span>
                        <span class="text-[10px] font-bold bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded">確保總額</span>
                    </div>
                </div>
            </div>
            <button onclick="resetAll()" class="w-10 h-10 rounded-full hover:bg-slate-100 text-slate-400 hover:text-rose-500 transition-colors" title="重置所有">
                <i class="fa-solid fa-arrows-rotate"></i>
            </button>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-5 space-y-6">
                
                <section class="bg-white rounded-3xl p-1 shadow-sm border border-slate-100">
                    <div class="px-5 py-3 border-b border-slate-50 flex justify-between items-center">
                        <h2 class="text-sm font-bold text-slate-500 flex items-center gap-2">
                            <i class="fa-solid fa-vault text-indigo-500"></i> 庫存設定
                        </h2>
                        <span id="inventory-total" class="text-xs font-bold font-mono text-emerald-600 bg-emerald-50 px-2 py-1 rounded-md tracking-tight">
                            總值: $0
                        </span>
                    </div>
                    <div class="p-4 grid grid-cols-2 gap-3">
                        <div class="relative bg-slate-50 rounded-xl p-3 border border-slate-100 focus-within:ring-2 focus-within:ring-indigo-100 transition-all">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-1">$10 紙幣</label>
                            <div class="flex items-center gap-2">
                                <span class="w-6 h-6 rounded bg-hk10 text-white text-xs flex items-center justify-center font-bold">$10</span>
                                <input type="number" id="inv-10" placeholder="0" oninput="updateInventory()" class="bg-transparent w-full text-xl font-bold text-slate-700 outline-none">
                            </div>
                        </div>
                        <div class="relative bg-slate-50 rounded-xl p-3 border border-slate-100 focus-within:ring-2 focus-within:ring-indigo-100 transition-all">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-1">$20 紙幣</label>
                            <div class="flex items-center gap-2">
                                <span class="w-6 h-6 rounded bg-hk20 text-white text-xs flex items-center justify-center font-bold">$20</span>
                                <input type="number" id="inv-20" placeholder="0" oninput="updateInventory()" class="bg-transparent w-full text-xl font-bold text-slate-700 outline-none">
                            </div>
                        </div>
                        <div class="relative bg-slate-50 rounded-xl p-3 border border-slate-100 focus-within:ring-2 focus-within:ring-indigo-100 transition-all">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-1">$50 紙幣</label>
                            <div class="flex items-center gap-2">
                                <span class="w-6 h-6 rounded bg-hk50 text-white text-xs flex items-center justify-center font-bold">$50</span>
                                <input type="number" id="inv-50" placeholder="0" oninput="updateInventory()" class="bg-transparent w-full text-xl font-bold text-slate-700 outline-none">
                            </div>
                        </div>
                        <div class="relative bg-slate-50 rounded-xl p-3 border border-slate-100 focus-within:ring-2 focus-within:ring-indigo-100 transition-all">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-1">$100 紙幣</label>
                            <div class="flex items-center gap-2">
                                <span class="w-6 h-6 rounded bg-hk100 text-white text-xs flex items-center justify-center font-bold">$100</span>
                                <input type="number" id="inv-100" placeholder="0" oninput="updateInventory()" class="bg-transparent w-full text-xl font-bold text-slate-700 outline-none">
                            </div>
                        </div>
                    </div>
                </section>

                <section class="glass-panel rounded-3xl shadow-xl flex flex-col h-[550px] relative overflow-hidden border border-white">
                    <div class="px-6 py-4 border-b border-slate-100 bg-white/60 flex justify-between items-center backdrop-blur-sm z-10">
                        <h2 class="font-bold text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-user-group text-indigo-500"></i> 分發名單
                        </h2>
                        <span id="people-count" class="text-xs font-bold text-slate-500 bg-white border border-slate-100 px-3 py-1 rounded-full shadow-sm">0 人</span>
                    </div>

                    <div class="p-5 bg-gradient-to-b from-white to-white/0 z-10">
                        <div class="flex gap-2">
                            <div class="flex-1 relative">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">$</span>
                                <input type="number" id="add-amount" placeholder="輸入金額 (如 500)" 
                                    class="w-full pl-8 pr-4 py-3 rounded-xl border border-gray-200 text-lg font-bold text-slate-700 shadow-sm focus:ring-4 focus:ring-indigo-100 focus:border-indigo-400 outline-none transition-all placeholder:font-normal placeholder:text-sm"
                                    onkeydown="if(event.key === 'Enter') addRecipient()">
                            </div>
                            <button onclick="addRecipient()" 
                                class="bg-slate-800 text-white px-5 rounded-xl font-bold shadow-lg shadow-slate-300 hover:scale-105 active:scale-95 transition-all">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                        <div class="flex justify-between items-start mt-2 px-1">
                            <p class="text-[10px] text-gray-400">* 尾數 5 自動變 0 (例: 25→20)</p>
                            <p id="input-error" class="text-rose-500 text-xs font-bold hidden flex items-center gap-1 animate-pulse">
                                <i class="fa-solid fa-circle-exclamation"></i> <span>錯誤</span>
                            </p>
                        </div>
                    </div>

                    <div id="recipient-list" class="flex-1 overflow-y-auto px-4 pb-4 space-y-2 custom-scroll">
                        <div id="empty-state" class="h-full flex flex-col items-center justify-center text-gray-300 space-y-3 opacity-60">
                            <i class="fa-solid fa-clipboard-list text-4xl"></i>
                            <p class="text-xs font-medium">尚未添加任何人</p>
                        </div>
                    </div>

                    <div class="p-4 bg-white border-t border-slate-100 z-10">
                        <div class="flex justify-between items-center text-xs text-gray-500 px-1 mb-3">
                            <span>總需求:</span>
                            <span class="text-lg font-black text-indigo-600 font-mono" id="total-demand">$0</span>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="clearRecipients()" class="px-4 py-3 rounded-xl text-rose-500 font-bold text-xs bg-rose-50 hover:bg-rose-100 transition-colors">
                                清空
                            </button>
                            <button onclick="calculate()" id="calc-btn" disabled
                                class="flex-1 py-3 px-4 rounded-xl font-bold text-white shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 bg-slate-200 cursor-not-allowed transition-all">
                                <i class="fa-solid fa-calculator"></i> 立即計算
                            </button>
                        </div>
                    </div>
                </section>
            </div>

            <div class="lg:col-span-7 relative min-h-[500px]">
                
                <div id="result-placeholder" class="absolute inset-0 rounded-3xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-400 p-8 select-none bg-white/40">
                    <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mb-4 shadow-sm">
                        <i class="fa-solid fa-wand-magic-sparkles text-3xl text-indigo-200"></i>
                    </div>
                    <h3 class="font-bold text-slate-500">準備就緒</h3>
                    <p class="text-xs mt-1 opacity-60">請在左側輸入資料並點擊計算</p>
                </div>

                <div id="result-container" class="hidden space-y-6 pb-10">
                    
                    <div id="status-card" class="result-enter relative overflow-hidden p-6 rounded-3xl shadow-xl flex flex-col md:flex-row items-center justify-between gap-6 text-white transition-all duration-500 bg-gradient-to-br from-emerald-500 to-teal-600 shadow-emerald-200">
                        <div class="flex items-center gap-5 z-10">
                            <div class="w-14 h-14 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-2xl" id="status-icon">
                                <i class="fa-solid fa-check"></i>
                            </div>
                            <div>
                                <h3 class="text-xs font-bold opacity-70 uppercase tracking-widest mb-1">分發報告</h3>
                                <p class="text-2xl font-black tracking-tight" id="status-text">全額分配完成</p>
                                <p class="mt-1 text-sm font-medium opacity-90" id="status-sub">庫存充足</p>
                            </div>
                        </div>
                        <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-white opacity-10 rounded-full blur-3xl"></div>
                    </div>

                    <div class="result-enter bg-slate-800 rounded-3xl p-6 shadow-lg border border-slate-700 text-white relative overflow-hidden" style="animation-delay: 0.1s;">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-500 opacity-10 rounded-full blur-3xl -mr-20 -mt-20"></div>
                        <h3 class="text-sm font-bold text-slate-300 mb-4 flex items-center gap-2 relative z-10">
                            <i class="fa-solid fa-box-open"></i> 分發後．剩餘庫存
                        </h3>
                        <div id="remaining-notes-container" class="flex flex-wrap gap-4 relative z-10">
                            </div>
                    </div>

                    <div class="result-enter bg-white rounded-3xl p-6 shadow-sm border border-slate-100" style="animation-delay: 0.2s;">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-bold text-slate-500 flex items-center gap-2">
                                <i class="fa-solid fa-hand-holding-dollar"></i> 總共需從保險箱取出
                            </h3>
                            <span id="total-sheets-count" class="text-[10px] font-black text-slate-500 bg-slate-100 px-2 py-1 rounded">
                                共 0 張
                            </span>
                        </div>
                        <div id="total-notes-container" class="flex flex-wrap gap-3">
                            </div>
                    </div>

                    <div class="result-enter bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden" style="animation-delay: 0.3s;">
                        <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="text-sm font-bold text-slate-700">分發詳情</h3>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-2 py-1 rounded flex items-center gap-1">
                                    <i class="fa-solid fa-robot"></i> 智能分配
                                </span>
                            </div>
                        </div>
                        <div id="detail-list" class="divide-y divide-slate-50">
                            </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script>
        let recipients = [];
        let inventory = { 10: 0, 20: 0, 50: 0, 100: 0 };

        // DOM Elements
        const inputAmount = document.getElementById('add-amount');
        const listContainer = document.getElementById('recipient-list');
        const emptyState = document.getElementById('empty-state');
        const errorMsg = document.getElementById('input-error');
        const calcBtn = document.getElementById('calc-btn');
        const resultContainer = document.getElementById('result-container');
        const resultPlaceholder = document.getElementById('result-placeholder');
        const inventoryTotalDisplay = document.getElementById('inventory-total');

        // Logic: Update Inventory
        function updateInventory() {
            [10, 20, 50, 100].forEach(d => {
                const el = document.getElementById(`inv-${d}`);
                inventory[d] = parseInt(el.value) || 0;
            });
            const total = (inventory[10]*10) + (inventory[20]*20) + (inventory[50]*50) + (inventory[100]*100);
            inventoryTotalDisplay.innerText = `總值: $${total.toLocaleString()}`;
            hideResult();
        }

        // Logic: Add Recipient
        function addRecipient() {
            let val = parseInt(inputAmount.value);
            
            if (isNaN(val) || val <= 0) {
                showError('請輸入有效金額');
                return;
            }
            if (val % 10 === 5) val -= 5;
            if (val <= 0 || val % 10 !== 0) {
                showError('金額需為10的倍數');
                return;
            }

            hideError();
            
            const id = Date.now();
            recipients.push({ id, amount: val, pref: 'mix' });
            
            renderRow(id, val, recipients.length);
            updateSummary();
            
            inputAmount.value = '';
            inputAmount.focus();
            hideResult();
            
            setTimeout(() => listContainer.scrollTop = listContainer.scrollHeight, 50);
        }

        function renderRow(id, amount, idx) {
            emptyState.classList.add('hidden');
            const div = document.createElement('div');
            div.id = `row-${id}`;
            div.className = 'animate-enter group flex items-center gap-3 bg-slate-50 p-3 rounded-2xl hover:bg-indigo-50 transition-colors border border-transparent hover:border-indigo-100';
            div.innerHTML = `
                <div class="w-6 h-6 rounded-full bg-white text-slate-400 text-[10px] font-bold flex items-center justify-center shadow-sm row-idx">${idx}</div>
                <div class="flex-1 flex items-center gap-1">
                    <span class="text-xs font-bold text-gray-400">$</span>
                    <input type="number" value="${amount}" onchange="updateRow(${id}, this.value)" 
                        class="bg-transparent font-bold text-slate-700 outline-none w-full border-b border-transparent focus:border-indigo-300">
                </div>
                <button onclick="removeRow(${id})" class="text-gray-300 hover:text-rose-500 transition-colors px-2">
                    <i class="fa-solid fa-trash"></i>
                </button>
            `;
            listContainer.appendChild(div);
        }

        function removeRow(id) {
            recipients = recipients.filter(r => r.id !== id);
            document.getElementById(`row-${id}`).remove();
            if (recipients.length === 0) emptyState.classList.remove('hidden');
            updateSummary();
            document.querySelectorAll('.row-idx').forEach((el, i) => el.innerText = i + 1);
            hideResult();
        }

        function updateRow(id, valStr) {
            let val = parseInt(valStr);
            if (!isNaN(val)) {
                if (val % 10 === 5) val -= 5;
                if (val > 0) {
                    recipients.find(r => r.id === id).amount = val;
                    document.querySelector(`#row-${id} input`).value = val;
                    updateSummary();
                    hideResult();
                }
            }
        }

        function clearRecipients() {
            if (recipients.length > 0 && confirm('清空名單？')) {
                recipients = [];
                listContainer.innerHTML = '';
                listContainer.appendChild(emptyState);
                emptyState.classList.remove('hidden');
                updateSummary();
                hideResult();
            }
        }

        function setPreference(id, type) {
            const person = recipients.find(r => r.id === id);
            if (person) {
                if (person.pref === type && type !== 'mix') {
                    person.pref = 'mix';
                } else {
                    person.pref = type;
                }
                calculate();
            }
        }

        function updateSummary() {
            const count = recipients.length;
            const total = recipients.reduce((sum, r) => sum + r.amount, 0);
            document.getElementById('people-count').innerText = `${count} 人`;
            document.getElementById('total-demand').innerText = `$${total.toLocaleString()}`;
            
            if (count > 0) {
                calcBtn.disabled = false;
                calcBtn.className = "flex-1 py-3 px-4 rounded-xl font-bold text-white shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 bg-gradient-to-r from-indigo-600 to-blue-600 hover:scale-[1.02] active:scale-[0.98] transition-all";
            } else {
                calcBtn.disabled = true;
                calcBtn.className = "flex-1 py-3 px-4 rounded-xl font-bold text-white shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 bg-slate-200 cursor-not-allowed transition-all";
            }
        }

        function showError(msg) {
            errorMsg.querySelector('span').innerText = msg;
            errorMsg.classList.remove('hidden');
        }
        function hideError() { errorMsg.classList.add('hidden'); }
        function hideResult() {
            resultContainer.classList.add('hidden');
            resultPlaceholder.classList.remove('hidden');
        }

        // --- NEW ALGORITHM: Balanced & Robust ---
        function calculate() {
            if (recipients.length === 0) return;

            let currentInv = { ...inventory };
            
            // Prepare State
            let allocStates = recipients.map(p => ({
                id: p.id,
                req: p.amount,
                pref: p.pref,
                remaining: p.amount,
                notes: { 10: 0, 20: 0, 50: 0, 100: 0 }
            }));

            // --- Phase 1: Preference Based Allocation (With Soft Limits) ---
            allocStates.forEach(state => {
                if (state.remaining <= 0) return;

                if (state.pref === 'max') {
                    // Strategy: Get rid of debt using biggest notes available first
                    // Loop: 100 -> 50 -> 20 -> 10
                    [100, 50, 20, 10].forEach(d => fillNotes(state, currentInv, d));
                }
                else if (state.pref === 'min') {
                    // Strategy: Give a "healthy amount" of small notes, but not insanity.
                    // 1. Give up to 15x $10 (Total $150)
                    fillNotes(state, currentInv, 10, 15); 
                    // 2. Give up to 10x $20 (Total $200)
                    fillNotes(state, currentInv, 20, 10);
                    // 3. Fill bulk with Large notes ($100, $50) to avoid carrying bricks
                    [100, 50].forEach(d => fillNotes(state, currentInv, d));
                    // 4. If still owing, use remaining small notes (Safe fallback)
                    [20, 10].forEach(d => fillNotes(state, currentInv, d));
                }
                else { // 'mix' (Default)
                    // 1. Ensure "Seed" variety (1 of each) if possible
                    [100, 50, 20, 10].forEach(d => fillNotes(state, currentInv, d, 1));
                    // 2. Fill Rest: Prioritize Large to save small notes for those who need them
                    [100, 50].forEach(d => fillNotes(state, currentInv, d));
                    // 3. Finish with small
                    [20, 10].forEach(d => fillNotes(state, currentInv, d));
                }
            });

            // --- Phase 2: SAFETY SWEEP (Ensure everyone gets paid) ---
            // If anyone is still owed money because of preference limits or order,
            // we ignore preferences and just pay them with WHATEVER is left.
            allocStates.forEach(state => {
                if (state.remaining > 0) {
                    // Try largest to smallest greedy fill to clear debt
                    [100, 50, 20, 10].forEach(d => fillNotes(state, currentInv, d));
                }
            });

            // Helper: Fill notes with optional limit
            function fillNotes(state, inv, denom, limit = Infinity) {
                if (state.remaining < denom) return; // Need less than this note
                
                let maxNeed = Math.floor(state.remaining / denom);
                let canTake = Math.min(maxNeed, inv[denom], limit);
                
                if (canTake > 0) {
                    state.notes[denom] += canTake;
                    inv[denom] -= canTake;
                    state.remaining -= (canTake * denom);
                }
            }

            // --- Stats Generation ---
            let totalUsed = { 10: 0, 20: 0, 50: 0, 100: 0 };
            let totalSuccess = 0;
            let logs = [];

            allocStates.forEach((state, idx) => {
                Object.keys(state.notes).forEach(k => totalUsed[k] += state.notes[k]);

                let log = {
                    id: state.id,
                    idx: idx + 1,
                    req: state.req,
                    pref: state.pref,
                    notes: state.notes,
                    missing: state.remaining
                };

                if (state.remaining === 0) {
                    log.success = true;
                    totalSuccess++;
                } else {
                    log.success = false;
                    log.reason = '庫存耗盡';
                }
                logs.push(log);
            });

            renderResults(logs, totalUsed, totalSuccess, currentInv);
        }

        function renderResults(logs, totalUsed, successCount, remainingInv) {
            resultPlaceholder.classList.add('hidden');
            resultContainer.classList.remove('hidden');

            // 1. Status
            const isPerfect = successCount === recipients.length;
            const card = document.getElementById('status-card');
            if (isPerfect) {
                card.className = "result-enter relative overflow-hidden p-6 rounded-3xl shadow-xl flex flex-col md:flex-row items-center justify-between gap-6 text-white transition-all duration-500 bg-gradient-to-br from-emerald-500 to-teal-600 shadow-emerald-200";
                document.getElementById('status-icon').innerHTML = '<i class="fa-solid fa-check"></i>';
                document.getElementById('status-text').innerText = "全額分配完成";
                document.getElementById('status-sub').innerText = "庫存充足，金額正確";
            } else {
                card.className = "result-enter relative overflow-hidden p-6 rounded-3xl shadow-xl flex flex-col md:flex-row items-center justify-between gap-6 text-white transition-all duration-500 bg-gradient-to-br from-rose-500 to-orange-600 shadow-orange-200";
                document.getElementById('status-icon').innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i>';
                document.getElementById('status-text').innerText = "庫存不足";
                document.getElementById('status-sub').innerText = "部分人士未能分配足夠金額";
            }

            // 2. Remaining Inventory
            const remContainer = document.getElementById('remaining-notes-container');
            remContainer.innerHTML = '';
            [100, 50, 20, 10].forEach(d => {
                const count = remainingInv[d];
                const opacity = count > 0 ? 'opacity-100' : 'opacity-30 grayscale';
                const color = d==100?'bg-hk100':d==50?'bg-hk50':d==20?'bg-hk20':'bg-hk10';
                remContainer.innerHTML += `
                    <div class="flex items-center gap-3 bg-slate-700/50 pr-4 pl-2 py-2 rounded-2xl border border-white/10 ${opacity}">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold shadow-sm ${color}">$${d}</div>
                        <div>
                            <div class="text-xl font-black text-white leading-none">${count}</div>
                            <div class="text-[10px] text-slate-400 font-bold uppercase mt-1">剩餘</div>
                        </div>
                    </div>
                `;
            });

            // 3. Usage
            const usedContainer = document.getElementById('total-notes-container');
            usedContainer.innerHTML = '';
            let totalSheets = 0;
            [100, 50, 20, 10].forEach(d => {
                const c = totalUsed[d];
                if (c > 0) {
                    totalSheets += c;
                    const color = d==100?'bg-hk100':d==50?'bg-hk50':d==20?'bg-hk20':'bg-hk10';
                    usedContainer.innerHTML += `
                        <div class="flex items-center gap-3 bg-slate-50 pr-4 pl-2 py-2 rounded-2xl border border-slate-100">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold shadow-sm ${color}">$${d}</div>
                            <div>
                                <div class="text-xl font-black text-slate-700 leading-none">${c}</div>
                                <div class="text-[10px] text-slate-400 font-bold uppercase mt-1">張</div>
                            </div>
                        </div>
                    `;
                }
            });
            document.getElementById('total-sheets-count').innerText = `共 ${totalSheets} 張`;

            // 4. Detailed List
            const listDiv = document.getElementById('detail-list');
            listDiv.innerHTML = '';
            
            logs.forEach(log => {
                let badgeHtml = '';
                [10, 20, 50, 100].forEach(d => {
                    if (log.notes[d] > 0) {
                        const color = d==100?'bg-hk100':d==50?'bg-hk50':d==20?'bg-hk20':'bg-hk10';
                        badgeHtml += `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold mr-1 text-white ${color}">$${d}<span class="ml-1 opacity-70">x${log.notes[d]}</span></span>`;
                    }
                });

                const statusIcon = log.success 
                    ? '<div class="w-6 h-6 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center"><i class="fa-solid fa-check text-xs"></i></div>'
                    : '<div class="w-6 h-6 rounded-full bg-rose-100 text-rose-600 flex items-center justify-center animate-pulse"><i class="fa-solid fa-xmark text-xs"></i></div>';
                
                const bgClass = log.success ? 'hover:bg-slate-50' : 'bg-rose-50/50';
                const missingText = log.success ? '' : `<span class="text-[10px] font-bold text-rose-500 block">欠 $${log.missing}</span>`;

                const btnBase = "w-8 h-8 rounded-full flex items-center justify-center text-xs transition-all border border-slate-200";
                
                const maxActive = log.pref === 'max';
                const maxClass = maxActive 
                    ? "bg-rose-500 text-white border-rose-500 shadow-md transform scale-110" 
                    : "bg-white text-slate-400 hover:text-rose-500 hover:border-rose-200";
                
                const minActive = log.pref === 'min';
                const minClass = minActive 
                    ? "bg-indigo-500 text-white border-indigo-500 shadow-md transform scale-110" 
                    : "bg-white text-slate-400 hover:text-indigo-500 hover:border-indigo-200";

                listDiv.innerHTML += `
                    <div class="px-6 py-3 flex flex-col sm:flex-row sm:items-center justify-between transition-colors border-b border-slate-50 last:border-0 ${bgClass} gap-3">
                        <div class="flex items-center gap-4 flex-1">
                            <div class="flex flex-col items-center gap-2">
                                <span class="font-mono text-[10px] font-bold text-slate-300">#${log.idx}</span>
                                <div class="flex flex-col gap-1">
                                    <button onclick="setPreference(${log.id}, 'max')" class="${btnBase} ${maxClass}" title="多大鈔">
                                        <i class="fa-solid fa-arrow-up-long"></i>
                                    </button>
                                    <button onclick="setPreference(${log.id}, 'min')" class="${btnBase} ${minClass}" title="多細鈔">
                                        <i class="fa-solid fa-arrow-down-long"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <span class="font-black text-slate-700 text-xl block">$${log.req}</span>
                                ${missingText}
                            </div>
                        </div>
                        <div class="flex-1 flex justify-end items-center gap-3">
                            <div class="flex flex-wrap justify-end gap-1 max-w-[200px]">${badgeHtml || '<span class="text-xs text-slate-300">-</span>'}</div>
                            ${statusIcon}
                        </div>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>

